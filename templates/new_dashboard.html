<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物流数据动态看板</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .dashboard-header {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .metrics-container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .metric-cards {
            display: flex;
            transition: transform 0.5s ease;
        }
        .metric-card {
            flex: 0 0 23%;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 0 1%;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-trend {
            font-size: 14px;
            margin-top: 10px;
        }
        .trend-up {
            color: #28a745;
        }
        .trend-down {
            color: #dc3545;
        }
        .carousel-controls {
            position: absolute;
            top: 50%;
            width: 100%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
        }
        .carousel-control {
            background-color: rgba(255,255,255,0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .table-container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .table-controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        .pagination-btn {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination-btn.active {
            background-color: #0d6efd;
            color: white;
        }
        .refresh-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1 class="text-center mb-4">物流数据动态看板</h1>
        
        <!-- 顶部动态图表 -->
        <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>实时数据趋势</h2>
                <div class="form-group">
                    <label for="timeGranularity">时间粒度：</label>
                    <select id="timeGranularity" class="form-control">
                        <option value="realtime">实时</option>
                        <option value="1min">1分钟</option>
                        <option value="5min">5分钟</option>
                    </select>
                </div>
            </div>
            <div class="chart-container" id="trendChart"></div>
            <div class="refresh-indicator" id="chartRefresh">最后更新：2026-02-24 12:00:00</div>
        </div>
        
        <!-- 中部指标卡片轮播 -->
        <div class="metrics-container">
            <h2 class="mb-3">关键指标</h2>
            <div class="metric-cards" id="metricCards">
                <!-- 指标卡片将通过JavaScript动态生成 -->
            </div>
            <div class="carousel-controls">
                <button class="carousel-control" id="prevCard">&lt;</button>
                <button class="carousel-control" id="nextCard">&gt;</button>
            </div>
            <div class="refresh-indicator" id="metricsRefresh">最后更新：2026-02-24 12:00:00</div>
        </div>
        
        <!-- 底部数据表格 -->
        <div class="table-container">
            <div class="table-controls">
                <h2>详细数据</h2>
                <div class="d-flex align-items-center">
                    <div class="form-group mr-3">
                        <label for="statusFilter">状态筛选：</label>
                        <select id="statusFilter" class="form-control">
                            <option value="all">全部</option>
                            <option value="delivered">已交付</option>
                            <option value="transit">运输中</option>
                            <option value="pending">待处理</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="搜索订单号或企业名称">
                    </div>
                </div>
            </div>
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th data-sort="orderId">订单号</th>
                        <th data-sort="company">企业名称</th>
                        <th data-sort="status">状态</th>
                        <th data-sort="origin">始发地</th>
                        <th data-sort="destination">目的地</th>
                        <th data-sort="time">时间</th>
                        <th data-sort="value">价值</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- 表格数据将通过JavaScript动态生成 -->
                </tbody>
            </table>
            <div class="table-pagination" id="tablePagination">
                <!-- 分页按钮将通过JavaScript动态生成 -->
            </div>
            <div class="refresh-indicator" id="tableRefresh">最后更新：2026-02-24 12:00:00</div>
        </div>
    </div>
    
    <script>
        // 全局变量
        let currentPage = 1;
        const pageSize = 10;
        let sortField = 'time';
        let sortDirection = 'desc';
        let currentCardIndex = 0;
        let chartInterval;
        let metricsInterval;
        let tableInterval;
        let timeGranularity = 'realtime';
        
        // 从API获取趋势数据
        const fetchTrendData = async () => {
            try {
                const response = await fetch(`/api/dashboard/trend?granularity=${timeGranularity}`);
                const result = await response.json();
                if (result.success) {
                    return result.data;
                } else {
                    console.error('获取趋势数据失败:', result.message);
                    return [];
                }
            } catch (error) {
                console.error('获取趋势数据出错:', error);
                return [];
            }
        };
        
        // 从API获取指标数据
        const fetchMetricsData = async () => {
            try {
                const response = await fetch('/api/dashboard/metrics');
                const result = await response.json();
                if (result.success) {
                    return result.data;
                } else {
                    console.error('获取指标数据失败:', result.message);
                    return [];
                }
            } catch (error) {
                console.error('获取指标数据出错:', error);
                return [];
            }
        };
        
        // 从API获取表格数据
        const fetchTableData = async () => {
            try {
                const statusFilter = document.getElementById('statusFilter').value;
                const searchTerm = document.getElementById('searchInput').value;
                
                const params = new URLSearchParams({
                    page: currentPage,
                    pageSize: pageSize,
                    status: statusFilter,
                    search: searchTerm,
                    sortField: sortField,
                    sortDirection: sortDirection
                });
                
                const response = await fetch(`/api/dashboard/table?${params}`);
                const result = await response.json();
                if (result.success) {
                    return result;
                } else {
                    console.error('获取表格数据失败:', result.message);
                    return { data: [], total: 0 };
                }
            } catch (error) {
                console.error('获取表格数据出错:', error);
                return { data: [], total: 0 };
            }
        };
        
        // 初始化图表
        const initChart = () => {
            const chartDom = document.getElementById('trendChart');
            const myChart = echarts.init(chartDom);
            
            const updateChart = async () => {
                const chartData = await fetchTrendData();
                
                if (chartData.length > 0) {
                    const option = {
                        title: {
                            text: '实时数据趋势',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'axis'
                        },
                        xAxis: {
                            type: 'category',
                            data: chartData.map(d => d.time),
                            axisLabel: {
                                rotate: 45
                            }
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            type: 'line',
                            data: chartData.map(d => d.value),
                            smooth: true,
                            areaStyle: {
                                opacity: 0.3
                            },
                            itemStyle: {
                                color: '#0d6efd'
                            }
                        }]
                    };
                    
                    myChart.setOption(option);
                }
                
                document.getElementById('chartRefresh').textContent = '最后更新：' + new Date().toLocaleString();
            };
            
            updateChart();
            chartInterval = setInterval(updateChart, 1000);
            
            // 响应式调整
            window.addEventListener('resize', () => {
                myChart.resize();
            });
            
            // 时间粒度选择器
            document.getElementById('timeGranularity').addEventListener('change', (e) => {
                timeGranularity = e.target.value;
                updateChart();
            });
        };
        
        // 初始化指标卡片
        const initMetrics = () => {
            const updateMetrics = async () => {
                const metrics = await fetchMetricsData();
                
                if (metrics.length > 0) {
                    const metricCardsContainer = document.getElementById('metricCards');
                    metricCardsContainer.innerHTML = '';
                    
                    metrics.forEach(metric => {
                        const card = document.createElement('div');
                        card.className = 'metric-card';
                        card.innerHTML = `
                            <div class="metric-name">${metric.name}</div>
                            <div class="metric-value">${metric.value}</div>
                            <div class="metric-trend ${metric.trendUp ? 'trend-up' : 'trend-down'}">
                                ${metric.trendUp ? '↑' : '↓'} ${metric.trend}%
                            </div>
                        `;
                        metricCardsContainer.appendChild(card);
                    });
                }
                
                document.getElementById('metricsRefresh').textContent = '最后更新：' + new Date().toLocaleString();
            };
            
            updateMetrics();
            metricsInterval = setInterval(updateMetrics, 5000);
            
            // 轮播控制
            document.getElementById('prevCard').addEventListener('click', () => {
                currentCardIndex = (currentCardIndex - 1 + 3) % 3; // 3组卡片
                updateCardPosition();
            });
            
            document.getElementById('nextCard').addEventListener('click', () => {
                currentCardIndex = (currentCardIndex + 1) % 3;
                updateCardPosition();
            });
            
            // 自动轮播
            setInterval(() => {
                currentCardIndex = (currentCardIndex + 1) % 3;
                updateCardPosition();
            }, 5000);
        };
        
        // 更新卡片位置
        const updateCardPosition = () => {
            const metricCardsContainer = document.getElementById('metricCards');
            metricCardsContainer.style.transform = `translateX(-${currentCardIndex * 100}%)`;
        };
        
        // 初始化数据表格
        const initTable = () => {
            const updateTable = async () => {
                await renderTable();
                document.getElementById('tableRefresh').textContent = '最后更新：' + new Date().toLocaleString();
            };
            
            updateTable();
            tableInterval = setInterval(updateTable, 10000);
            
            // 排序
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.getAttribute('data-sort');
                    if (sortField === field) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortField = field;
                        sortDirection = 'asc';
                    }
                    currentPage = 1; // 重置到第一页
                    renderTable();
                });
            });
            
            // 筛选
            document.getElementById('statusFilter').addEventListener('change', () => {
                currentPage = 1; // 重置到第一页
                renderTable();
            });
            document.getElementById('searchInput').addEventListener('input', () => {
                currentPage = 1; // 重置到第一页
                renderTable();
            });
        };
        
        // 渲染表格
        const renderTable = async () => {
            const result = await fetchTableData();
            const tableData = result.data || [];
            const total = result.total || 0;
            
            // 渲染表格数据
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            
            if (tableData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="text-center">暂无数据</td>`;
                tableBody.appendChild(row);
            } else {
                tableData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.orderId}</td>
                        <td>${item.company}</td>
                        <td>
                            <span class="badge ${item.status === '已交付' ? 'bg-success' : item.status === '运输中' ? 'bg-warning' : 'bg-secondary'}">
                                ${item.status}
                            </span>
                        </td>
                        <td>${item.origin}</td>
                        <td>${item.destination}</td>
                        <td>${item.time}</td>
                        <td>¥${item.value}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // 渲染分页
            const pagination = document.getElementById('tablePagination');
            pagination.innerHTML = '';
            
            const totalPages = Math.ceil(total / pageSize);
            if (totalPages > 0) {
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    btn.textContent = i;
                    btn.addEventListener('click', () => {
                        currentPage = i;
                        renderTable();
                    });
                    pagination.appendChild(btn);
                }
            }
        };
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            initMetrics();
            initTable();
        });
        
        // 清理定时器
        window.addEventListener('beforeunload', () => {
            clearInterval(chartInterval);
            clearInterval(metricsInterval);
            clearInterval(tableInterval);
        });
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>