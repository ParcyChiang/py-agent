<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶ç›‘æ§ä»ªè¡¨æ¿ - ç‰©æµæ™ºèƒ½åˆ†æ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>å®æ—¶ç›‘æ§ä»ªè¡¨æ¿</h1>
            <p>å®æ—¶ç›‘æ§ç‰©æµè¿è¥çŠ¶æ€å’Œå…³é”®æŒ‡æ ‡ï¼ŒåŠ©åŠ›ä¸šåŠ¡å†³ç­–</p>
        </header>

        <nav class="nav">
            <a href="/">é¦–é¡µ</a>
            <a class="secondary" href="/page/upload">æ•°æ®å¯¼å…¥</a>
            <a class="secondary" href="/page/analyze">è¿è¥åˆ†æ</a>
            <a class="secondary" href="/page/shipments">æ•°æ®åˆ—è¡¨</a>
            <a class="secondary" href="/page/report">æ—¥æŠ¥ä¸­å¿ƒ</a>
            <a class="secondary" href="/page/dashboard">å®æ—¶ç›‘æ§</a>
            <a class="secondary" href="/page/code_generator">ä»£ç ç”Ÿæˆå™¨</a>
            <a class="secondary" href="/page/admin_log">æ—¥å¿—ä¸­å¿ƒ</a>
        </nav>

        <div class="auto-refresh">
            <span id="refreshStatus">è‡ªåŠ¨åˆ·æ–°: å¼€å¯</span>
            <button id="toggleRefresh">å…³é—­</button>
        </div>

        <div class="dashboard-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-label">æ€»å‘è´§é‡</div>
                    <div class="metric-icon" style="background-color: #E6F7FF; color: #165DFF;">ğŸ“¦</div>
                </div>
                <div class="metric-value" id="totalShipments">-</div>
                <div class="metric-trend trend-up">
                    <span>â†‘</span>
                    <span>ä»Šæ—¥ +12%</span>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-label">æ€»äº¤ä»˜é‡</div>
                    <div class="metric-icon" style="background-color: #F6FFED; color: #52C41A;">âœ…</div>
                </div>
                <div class="metric-value" id="deliveredAll">-</div>
                <div class="metric-trend trend-up">
                    <span>â†‘</span>
                    <span>ä»Šæ—¥ +8%</span>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-label">è¿è¾“ä¸­</div>
                    <div class="metric-icon" style="background-color: #FFF7E6; color: #FFA940;">ğŸšš</div>
                </div>
                <div class="metric-value" id="inTransit">-</div>
                <div class="metric-trend trend-down">
                    <span>â†“</span>
                    <span>ä»Šæ—¥ -5%</span>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-label">ä»Šæ—¥äº¤ä»˜</div>
                    <div class="metric-icon" style="background-color: #F9F0FF; color: #722ED1;">ğŸ‰</div>
                </div>
                <div class="metric-value" id="deliveredToday">-</div>
                <div class="metric-trend trend-up">
                    <span>â†‘</span>
                    <span>è¾ƒæ˜¨æ—¥ +15%</span>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-label">äº¤ä»˜ç‡</div>
                    <div class="metric-icon" style="background-color: #FFF2F0; color: #FF4D4F;">ğŸ“Š</div>
                </div>
                <div class="metric-value" id="deliveryRate">-</div>
                <div class="metric-trend trend-up">
                    <span>â†‘</span>
                    <span>è¾ƒæ˜¨æ—¥ +2%</span>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h3>å®æ—¶çŠ¶æ€åˆ†å¸ƒ</h3>
                <canvas id="realtimeStatusChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-container square-chart-container">
                <h3>æ¯æ—¥è¶‹åŠ¿åˆ†æ</h3>
                <div class="square-chart-wrapper">
                    <canvas id="dailyTrendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="three-d-charts">
            <div class="three-d-chart">
                <h3>å®æ—¶ä¸‰ç»´æ›²é¢å›¾</h3>
                <img id="realtimeSurface3D" class="chart-image" alt="å®æ—¶ä¸‰ç»´æ›²é¢å›¾">
            </div>
            
            <div class="three-d-chart">
                <h3>å®æ—¶ä¸‰ç»´æ•£ç‚¹å›¾</h3>
                <img id="realtimeScatter3D" class="chart-image" alt="å®æ—¶ä¸‰ç»´æ•£ç‚¹å›¾">
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let realtimeStatusChart;
        let dailyTrendChart;
        let autoRefreshInterval;
        let isAutoRefresh = true;
        
        // åˆ›å»ºå®æ—¶çŠ¶æ€åˆ†å¸ƒå›¾è¡¨
        function createRealtimeStatusChart(statusData) {
            const ctx = document.getElementById('realtimeStatusChart').getContext('2d');
            if (realtimeStatusChart) realtimeStatusChart.destroy();
            
            // æ˜ å°„ä¸­æ–‡çŠ¶æ€åˆ°å‹å¥½çš„æ˜¾ç¤ºåç§°
            const statusLabels = {
                'delivered': 'å·²äº¤ä»˜',
                'in_transit': 'è¿è¾“ä¸­',
                'pending': 'å¾…å¤„ç†',
                'delayed': 'å»¶è¿Ÿ',
                'å·²äº¤ä»˜': 'å·²äº¤ä»˜',
                'è¿è¾“ä¸­': 'è¿è¾“ä¸­',
                'å¾…å¤„ç†': 'å¾…å¤„ç†',
                'å»¶è¿Ÿ': 'å»¶è¿Ÿ'
            };
            
            // å¤„ç†çŠ¶æ€æ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰çŠ¶æ€éƒ½æœ‰å€¼
            const processedData = {
                'å·²äº¤ä»˜': statusData['delivered'] || statusData['å·²äº¤ä»˜'] || 0,
                'è¿è¾“ä¸­': statusData['in_transit'] || statusData['è¿è¾“ä¸­'] || 0,
                'å¾…å¤„ç†': statusData['pending'] || statusData['å¾…å¤„ç†'] || 0,
                'å»¶è¿Ÿ': statusData['delayed'] || statusData['å»¶è¿Ÿ'] || 0
            };
            
            // è¿‡æ»¤æ‰å€¼ä¸º0çš„çŠ¶æ€
            const filteredLabels = Object.keys(processedData).filter(key => processedData[key] > 0);
            const filteredValues = filteredLabels.map(key => processedData[key]);
            
            realtimeStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        data: filteredValues,
                        backgroundColor: [
                            '#00B42A',  // å·²äº¤ä»˜ - ç»¿è‰²
                            '#FF7D00',  // è¿è¾“ä¸­ - æ©™è‰²
                            '#165DFF',  // å¾…å¤„ç† - è“è‰²
                            '#F53F3F'   // å»¶è¿Ÿ - çº¢è‰²
                        ],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 13
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            cornerRadius: 8
                        }
                    },
                    cutout: '70%'
                }
            });
        }
        
        // åˆ›å»ºæ¯æ—¥è¶‹åŠ¿åˆ†æå›¾è¡¨
        function createDailyTrendChart(dailyTrendData) {
            const ctx = document.getElementById('dailyTrendChart').getContext('2d');
            if (dailyTrendChart) dailyTrendChart.destroy();
            
            console.log('createDailyTrendChart called with data:', dailyTrendData);
            
            // å¤„ç†çœŸå®æ•°æ®
            let dates = [];
            let deliveredData = [];
            let inTransitData = [];
            let shipmentsData = [];
            
            try {
                // åˆ›å»ºæ—¥æœŸæ˜ å°„è¡¨ä»¥ä¾¿å¿«é€ŸæŸ¥æ‰¾
                const deliveredMap = {};
                const inTransitMap = {};
                const shipmentsMap = {};
                
                // å¡«å……æ˜ å°„è¡¨
                if (dailyTrendData && dailyTrendData.delivered) {
                    dailyTrendData.delivered.forEach(item => {
                        deliveredMap[item.date] = item.delivered;
                    });
                }
                
                if (dailyTrendData && dailyTrendData.in_transit) {
                    dailyTrendData.in_transit.forEach(item => {
                        inTransitMap[item.date] = item.in_transit;
                    });
                }
                
                if (dailyTrendData && dailyTrendData.shipments) {
                    dailyTrendData.shipments.forEach(item => {
                        shipmentsMap[item.date] = item.shipments;
                        dates.push(item.date); // ä»¥å‘è´§é‡çš„æ—¥æœŸä½œä¸ºåŸºå‡†
                    });
                }
                
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡
                if (dates.length === 0) {
                    console.log('Using mock data for daily trend chart');
                    const mockDates = ['1æœˆ1æ—¥', '1æœˆ2æ—¥', '1æœˆ3æ—¥', '1æœˆ4æ—¥', '1æœˆ5æ—¥', '1æœˆ6æ—¥', '1æœˆ7æ—¥'];
                    mockDates.forEach(date => {
                        dates.push(date);
                        deliveredMap[date] = Math.floor(Math.random() * 500) + 100;
                        inTransitMap[date] = Math.floor(Math.random() * 400) + 150;
                        shipmentsMap[date] = Math.floor(Math.random() * 600) + 200;
                    });
                }
                
                // æŒ‰æ—¥æœŸæ’åº
                dates.sort();
                
                // å¡«å……æ•°æ®æ•°ç»„
                dates.forEach(date => {
                    deliveredData.push(deliveredMap[date] || 0);
                    inTransitData.push(inTransitMap[date] || 0);
                    shipmentsData.push(shipmentsMap[date] || 0);
                });
                
                // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºä¸ºå¹´æœˆæ—¥
                const formattedDates = dates.map(date => {
                    // æ£€æŸ¥æ—¥æœŸæ ¼å¼ï¼Œå¦‚æœæ˜¯ISOæ ¼å¼ï¼ˆå¦‚2025-12-25ï¼‰åˆ™ç›´æ¥ä½¿ç”¨
                    if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                        return date;
                    }
                    // å¦åˆ™å°è¯•è§£æå¹¶æ ¼å¼åŒ–
                    const d = new Date(date);
                    if (!isNaN(d.getTime())) {
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    }
                    // å¦‚æœæ— æ³•è§£æï¼Œä¿ç•™åŸå§‹æ—¥æœŸ
                    return date;
                });
                
                // è®¡ç®—yè½´æœ€å¤§å€¼ï¼ˆæ‰¾åˆ°æ‰€æœ‰æ•°æ®ç‚¹çš„æœ€å¤§å€¼ï¼Œç„¶åå‘ä¸Šå–æ•´åˆ°åˆé€‚çš„å€¼ï¼‰
                const allData = [...deliveredData, ...inTransitData, ...shipmentsData];
                const maxValue = Math.max(...allData);
                // æ‰¾åˆ°æœ€é«˜æ‹ç‚¹åï¼Œå‘ä¸Šå–æ•´åˆ°åˆé€‚çš„æ•°å€¼ï¼ˆå¦‚100çš„å€æ•°ï¼‰
                const yMax = Math.ceil(maxValue / 100) * 100;
                
                console.log('Processing data - dates:', dates);
                console.log('Formatted dates:', formattedDates);
                console.log('Delivered data:', deliveredData);
                console.log('In transit data:', inTransitData);
                console.log('Shipments data:', shipmentsData);
                console.log('Calculated yMax:', yMax);
                
                dailyTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: formattedDates,
                        datasets: [{
                            label: 'äº¤ä»˜é‡',
                            data: deliveredData,
                            borderColor: '#00B42A',
                            backgroundColor: 'rgba(0, 180, 42, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'è¿è¾“ä¸­',
                            data: inTransitData,
                            borderColor: '#FF7D00',
                            backgroundColor: 'rgba(255, 125, 0, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'å‘è´§é‡',
                            data: shipmentsData,
                            borderColor: '#165DFF',
                            backgroundColor: 'rgba(22, 93, 255, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: yMax
                            },
                            x: {
                                // ç¡®ä¿xè½´æ ‡ç­¾æ˜¾ç¤ºä¸ºå¹´æœˆæ—¥æ ¼å¼
                                ticks: {
                                    callback: function(value, index, values) {
                                        return values[index];
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('Chart created successfully');
            } catch (error) {
                console.error('Error creating chart:', error);
            }
        }
        
        // æ˜¾ç¤ºå®æ—¶ä¸‰ç»´å›¾è¡¨
        function displayRealtime3DCharts(chartData) {
            // æ˜¾ç¤ºå®æ—¶ä¸‰ç»´æ›²é¢å›¾
            if (chartData.surface_3d) {
                document.getElementById('realtimeSurface3D').src = 'data:image/png;base64,' + chartData.surface_3d;
            } else {
                document.getElementById('realtimeSurface3D').src = '';
                document.getElementById('realtimeSurface3D').alt = 'æš‚æ— å®æ—¶ä¸‰ç»´æ›²é¢å›¾æ•°æ®';
            }
            
            // æ˜¾ç¤ºå®æ—¶ä¸‰ç»´æ•£ç‚¹å›¾
            if (chartData.scatter_3d) {
                document.getElementById('realtimeScatter3D').src = 'data:image/png;base64,' + chartData.scatter_3d;
            } else {
                document.getElementById('realtimeScatter3D').src = '';
                document.getElementById('realtimeScatter3D').alt = 'æš‚æ— å®æ—¶ä¸‰ç»´æ•£ç‚¹å›¾æ•°æ®';
            }
        }
        
        // æ›´æ–°ä»ªè¡¨ç›˜æ•°æ®
        function updateDashboard() {
            $.getJSON('/analyze', function(response) {
                if (response.success) {
                    // ç»Ÿä¸€æ•°æ®å¼•ç”¨ä¸ä¸­è‹±æ–‡é”®å…¼å®¹
                    const statusDist = response.summary && response.summary.status_distribution ? response.summary.status_distribution : {};
                    const totalRecords = (response.summary && response.summary.total_records) || 0;
                    const totalToday = (response.statistics && response.statistics.total_shipments) || 0; // ä»Šæ—¥å…¥åº“/åˆ›å»º
                    const deliveredToday = (response.statistics && response.statistics.delivered) || 0; // ä»Šæ—¥äº¤ä»˜
                    const deliveredAll = statusDist['delivered'] || statusDist['å·²é€è¾¾'] || 0; // æ€»äº¤ä»˜é‡
                    const inTransitAll = statusDist['in_transit'] || statusDist['è¿è¾“ä¸­'] || 0; // è¿è¾“ä¸­ï¼ˆæ€»é‡ï¼‰

                    // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
                    $('#totalShipments').text(totalRecords.toLocaleString());
                    $('#deliveredAll').text(deliveredAll.toLocaleString());
                    $('#deliveredToday').text(deliveredToday.toLocaleString());
                    $('#inTransit').text(inTransitAll.toLocaleString());

                    // äº¤ä»˜ç‡ï¼šä½¿ç”¨æ€»äº¤ä»˜é‡ / æ€»å‘è´§é‡
                    const denom = totalRecords > 0 ? totalRecords : 1;
                    const rate = Math.round((deliveredAll / denom) * 100);
                    $('#deliveryRate').text(rate + '%');
                    
                    // æ›´æ–°å›¾è¡¨
                    createRealtimeStatusChart(response.summary.status_distribution);
                    createDailyTrendChart(response.statistics.daily_trend);
                    displayRealtime3DCharts(response.statistics);
                }
            }).fail(function() {
                console.log('æ•°æ®æ›´æ–°å¤±è´¥');
            });
        }
        
        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(updateDashboard, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(function(){
            // åˆå§‹åŠ è½½æ•°æ®
            updateDashboard();
            
            // è‡ªåŠ¨åˆ·æ–°æ§åˆ¶
            $('#toggleRefresh').on('click', function() {
                isAutoRefresh = !isAutoRefresh;
                if (isAutoRefresh) {
                    startAutoRefresh();
                    $('#refreshStatus').text('è‡ªåŠ¨åˆ·æ–°: å¼€å¯');
                    $(this).text('å…³é—­');
                } else {
                    stopAutoRefresh();
                    $('#refreshStatus').text('è‡ªåŠ¨åˆ·æ–°: å…³é—­');
                    $(this).text('å¼€å¯');
                }
            });
            
            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
            startAutoRefresh();
        });
    </script>
</body>
</html>
